# Utility Modules

Three utility modules in `app/src/renderer/utils/` provide shared helper functions for asset URL resolution, data formatting, and Hytale i18n key translation. These modules are consumed by renderer components and stores.

---

## asset-paths.ts

**Source:** `app/src/renderer/utils/asset-paths.ts`

Provides URL builders for the custom `asset://` protocol and manages a lazy-loaded icon map that resolves Hytale item IDs to their actual icon filenames.

### Icon Map (Internal State)

The module maintains a private `itemIconMap` variable (`Record<string, string> | null`) that maps item IDs to icon filenames. This map is loaded lazily from `asset:///item-icon-map.json` -- a JSON file generated by the asset extractor during `Assets.zip` extraction. The map is needed because some item IDs do not directly correspond to their icon filenames.

```
itemIconMap = null  (not yet loaded)
         |
   loadIconMap() fetches asset:///item-icon-map.json
         |
itemIconMap = { "Weapon_Daggers_Adamantite": "daggers_adamantite", ... }
```

If the fetch fails or returns a non-OK response, `itemIconMap` is set to an empty object `{}` so the module degrades gracefully (item IDs are used as-is for the filename).

### Exported Functions

#### `getItemIconPath(itemId: string): string`

Returns the `asset://` URL for an item icon. Uses the icon map to resolve the item ID to its actual filename. If the map is not loaded or does not contain the item ID, the raw `itemId` is used as the filename.

```typescript
getItemIconPath('Weapon_Daggers_Adamantite')
// If icon map has mapping: 'asset:///items/daggers_adamantite.png'
// If no mapping found:     'asset:///items/Weapon_Daggers_Adamantite.png'
```

**Important:** This function is synchronous. It reads from the in-memory `itemIconMap`. The map must be loaded first via `itemIconMapReady()` or `reloadIconMap()` before results are accurate.

#### `itemIconMapReady` (alias for `loadIconMap`)

An exported alias for the internal `loadIconMap()` function. Returns a `Promise<Record<string, string>>` that resolves to the icon map. If the map is already loaded, it returns immediately from cache. If not, it fetches `asset:///item-icon-map.json`.

```typescript
import { itemIconMapReady } from '../utils/asset-paths';

// Ensure the icon map is loaded before rendering item icons
await itemIconMapReady();
```

#### `getNpcPortraitPath(npcRole: string): string`

Returns the `asset://` URL for an NPC portrait image. No icon map lookup is needed -- the NPC role string is used directly as the filename.

```typescript
getNpcPortraitPath('Goblin_Hermit')
// Returns: 'asset:///npcs/Goblin_Hermit.png'
```

#### `getMapMarkerPath(markerType: string): string`

Returns the `asset://` URL for a map marker icon. The marker type string is used directly as the filename.

```typescript
getMapMarkerPath('Cave')
// Returns: 'asset:///map-markers/Cave.png'
```

#### `reloadIconMap(): Promise<Record<string, string>>`

Forces a reload of the icon map by clearing the cache (`itemIconMap = null`) and re-fetching `asset:///item-icon-map.json`. Returns a promise that resolves to the new map.

This function is called by the `ItemIcon` component when the `asset-store` status transitions to `'ready'`, ensuring that newly extracted assets are picked up:

```typescript
// In ItemIcon.tsx
useEffect(() => {
  if (assetStatus === 'ready') {
    reloadIconMap().then(() => {
      setMapLoaded(true);
      setImgError(false);
    });
  }
}, [assetStatus]);
```

#### `resetIconMap(): void`

Clears the cached icon map by setting `itemIconMap = null` without re-fetching. The next call to `getItemIconPath()` will use the raw item ID as the filename until the map is reloaded.

This is useful for testing or when the asset cache is invalidated and icons should not be resolved until fresh data is available.

### Component Integration

The `ItemIcon` component (`app/src/renderer/components/players/ItemIcon.tsx`) is the primary consumer of this module:

1. On mount (or when `assetStatus` changes to `'ready'`), it calls `reloadIconMap()`.
2. Once the map is loaded, it calls `getItemIconPath(itemId)` to get the image URL.
3. If the image fails to load (`onError`), it falls back to a text label using `formatItemId()` from `translation.ts`.

---

## formatting.ts

**Source:** `app/src/renderer/utils/formatting.ts`

Display formatting utilities for coordinates, dates, byte sizes, and item durability. Imports `Position` from `../types/player`.

### Exported Functions

#### `formatCoords(pos: Position): string`

Formats a 3D position into a readable coordinate string with one decimal place.

| Input | Output |
|-------|--------|
| `{ x: 1024.5, y: 72.0, z: -512.3 }` | `"X: 1024.5, Y: 72.0, Z: -512.3"` |
| `{ x: 0, y: 0, z: 0 }` | `"X: 0.0, Y: 0.0, Z: 0.0"` |

#### `formatDate(date: Date | number): string`

Formats a `Date` object or Unix timestamp (milliseconds) into a localized date/time string. Uses the browser's locale with `toLocaleDateString()`.

| Input | Output (en-US locale) |
|-------|--------|
| `1707500000000` | `"Feb 9, 2024, 04:53 PM"` |
| `new Date('2026-02-14')` | `"Feb 14, 2026, 12:00 AM"` |

The format options used: `year: 'numeric'`, `month: 'short'`, `day: 'numeric'`, `hour: '2-digit'`, `minute: '2-digit'`.

#### `formatBytes(bytes: number): string`

Formats a byte count into a human-readable size string using KB/MB units (base 1024).

| Input | Output |
|-------|--------|
| `512` | `"512 B"` |
| `2048` | `"2.0 KB"` |
| `1572864` | `"1.5 MB"` |
| `0` | `"0 B"` |

Thresholds: below 1024 shows bytes, below 1024*1024 shows KB (1 decimal), otherwise shows MB (1 decimal).

#### `formatDurability(current: number, max: number): string`

Formats item durability as a `current/max` string. Returns an empty string if `max` is 0 (non-durable items).

| Input | Output |
|-------|--------|
| `(80, 100)` | `"80/100"` |
| `(149.7, 200)` | `"150/200"` |
| `(0, 0)` | `""` |

Values are rounded using `Math.round()`.

#### `durabilityPercent(current: number, max: number): number`

Calculates durability as a percentage (0-100). Returns 100 if `max` is 0 (avoids division by zero for non-durable items).

| Input | Output |
|-------|--------|
| `(80, 100)` | `80` |
| `(149.7, 200)` | `75` |
| `(0, 0)` | `100` |

---

## translation.ts

**Source:** `app/src/renderer/utils/translation.ts`

Converts Hytale i18n translation keys and item identifiers into human-readable display names. The Hytale server uses dot-delimited translation keys (e.g., `server.npcRoles.Goblin_Hermit.name`) and underscore-delimited item IDs (e.g., `Weapon_Daggers_Adamantite`). These functions extract the meaningful portion and format it for display.

### Exported Functions

#### `formatTranslationKey(key: string): string`

Extracts a readable name from a Hytale i18n translation key. Takes the second-to-last segment if the key has 3+ parts (skipping the trailing `.name` or similar suffix), otherwise takes the last segment. Underscores are replaced with spaces.

| Input | Output |
|-------|--------|
| `"server.npcRoles.Goblin_Hermit.name"` | `"Goblin Hermit"` |
| `"server.map.region.Zone3_Tier1"` | `"Zone3 Tier1"` |
| `"server.map.markers.Cave_Entrance.name"` | `"Cave Entrance"` |
| `"SimpleKey"` | `"SimpleKey"` |
| `"two.parts"` | `"parts"` |

**Used by:** The main-process data readers (`player-reader.ts` and `world-reader.ts`) also have their own copy of this function to translate zone names and map marker names before sending data to the renderer.

#### `formatItemId(id: string): string`

Formats a Hytale item ID into a readable name by splitting on underscores and removing common category prefixes. The recognized prefixes are: `Weapon`, `Armor`, `Tool`, `Food`, `Furniture`, `Potion`, `EditorTool`.

| Input | Output |
|-------|--------|
| `"Weapon_Daggers_Adamantite"` | `"Daggers Adamantite"` |
| `"Armor_Cobalt_Head"` | `"Cobalt Head"` |
| `"Tool_Pickaxe_Iron"` | `"Pickaxe Iron"` |
| `"Food_Apple"` | `"Apple"` |
| `"Potion_Health_Large"` | `"Health Large"` |
| `"EditorTool_Brush"` | `"Brush"` |
| `"Furniture_Chair_Wooden"` | `"Chair Wooden"` |
| `"Raw_Diamond"` | `"Raw Diamond"` |

If the first segment is not a recognized prefix, all segments are joined with spaces (no removal).

**Used by:** `ItemIcon` component -- when an item icon image fails to load, `formatItemId()` generates the fallback text label.
